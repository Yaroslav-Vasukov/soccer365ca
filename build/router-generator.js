// build/router-generator.js
import path from "path";
import fs from "fs";
import { fileURLToPath } from "url";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// =============================================================================
// ROUTER CONFIGURATION
// =============================================================================

// –ë–∞–∑–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü
const DEFAULT_PAGE_CONFIG = {
  pin: "",
  isHome: false,
  category: "page", // page, news, video, etc.
  meta: {}
};

// –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü
const PAGE_OVERRIDES = {
  // –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
  'home': {
    name: 'Home',
    url: '',
    isHome: true,
    category: 'main'
  },
  
  // –û—Å–Ω–æ–≤–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã
  'news': {
    name: 'News',
    url: 'news',
    category: 'content'
  },
  'lives': {
    name: 'Lives',
    url: 'lives',
    category: 'content'
  },
  'videos': {
    name: 'Videos',
    url: 'videos',
    category: 'content'
  },
  
  // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  'calendar': {
    name: 'Calendar',
    url: 'calendar',
    category: 'info'
  },
  'history': {
    name: 'History',
    url: 'history',
    category: 'info'
  },
  'teams': {
    name: 'Teams',
    url: 'teams',
    category: 'info'
  },
  'league': {
    name: 'League',
    url: 'league',
    category: 'info'
  },
  
  // –î–µ—Ç–∞–ª—å–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–æ–±—ã—á–Ω–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ)
  'post': {
    name: 'Post',
    url: 'post',
    category: 'detail',
    meta: { dynamic: true, template: 'post' }
  },
  'video': {
    name: 'Video',
    url: 'video',
    category: 'detail',
    meta: { dynamic: true, template: 'video' }
  },
  'team': {
    name: 'Team',
    url: 'team',
    category: 'detail',
    meta: { dynamic: true, template: 'team' }
  },
  'player': {
    name: 'Player',
    url: 'player',
    category: 'detail',
    meta: { dynamic: true, template: 'player' }
  },
  'review': {
    name: 'Review',
    url: 'review',
    category: 'detail',
    meta: { dynamic: true, template: 'review' }
  },
  
  // –°–ª—É–∂–µ–±–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  'contact': {
    name: 'Contact',
    url: 'contact',
    category: 'service'
  },
  'privacy': {
    name: 'Privacy',
    url: 'privacy',
    category: 'service'
  }
};


// =============================================================================
// ROUTER GENERATION
// =============================================================================

export function generateRouterConfig(projectRoot = process.cwd()) {
  const pagesDir = path.resolve(projectRoot, "dev/pages");
  const router = [];
  
  if (!fs.existsSync(pagesDir)) {
    console.warn("‚ö†Ô∏è Pages directory not found:", pagesDir);
    return router;
  }
  
  // –°–∫–∞–Ω–∏—Ä—É–µ–º HTML —Ñ–∞–π–ª—ã
  const files = fs.readdirSync(pagesDir)
    .filter(file => file.endsWith('.html'))
    .sort();
  
  for (const file of files) {
    const pageName = path.basename(file, '.html');
    const isHome = pageName === 'home';
    
    // –ü—Ä–æ—Å—Ç–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è - —Ç–æ—á–Ω–æ –∫–∞–∫ –≤ –≤–∞—à–µ–º —Ñ–∞–π–ª–µ
    const config = {
      file: isHome ? 'home.html' : `pages/${file}`,
      name: getPageName(pageName),
      pin: "",
      url: getPageUrl(pageName),
      isHome: isHome
    };
    
    router.push(config);
  }
  
  // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: Home –ø–µ—Ä–≤—ã–º, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É
  router.sort((a, b) => {
    if (a.isHome) return -1;
    if (b.isHome) return 1;
    return a.name.localeCompare(b.name);
  });
  
  return router;
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–º–µ–Ω–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
function getPageName(pageName) {
  const names = {
    'home': 'Home',
    'calendar': 'Calendar',
    'contact': 'Contact', 
    'history': 'History',
    'lives': 'Lives',
    'news': 'News',
    'player': 'Player',
    'post': 'Post',
    'review': 'Review',
    'team': 'Team',
    'teams': 'Teams',
    'video': 'Video',
    'videos': 'Videos',
    'league': 'League',
    'leagues': 'Leagues',
    'privacy': 'Privacy'
  };
  
  return names[pageName] || capitalize(pageName);
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ URL —Å—Ç—Ä–∞–Ω–∏—Ü—ã  
function getPageUrl(pageName) {
  const urls = {
    'home': '' // –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
  };
  
  return urls[pageName] !== undefined ? urls[pageName] : pageName;
}

// =============================================================================
// ROUTER UTILS
// =============================================================================

export function updateDevRouter(projectRoot = process.cwd()) {
  const routerPath = path.resolve(projectRoot, "dev/__router.json");
  const router = generateRouterConfig(projectRoot);
  
  try {
    // –ß–∏—Ç–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ–∞–π–ª –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö pin
    let existingCustomData = {};
    if (fs.existsSync(routerPath)) {
      try {
        const existing = JSON.parse(fs.readFileSync(routerPath, 'utf8'));
        existing.forEach(page => {
          const key = getPageKey(page);
          if (page.pin || page.meta?.custom) {
            existingCustomData[key] = {
              pin: page.pin,
              customMeta: page.meta?.custom
            };
          }
        });
      } catch (e) {
        console.warn('‚ö†Ô∏è Could not parse existing router:', e.message);
      }
    }
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∫–∞—Å—Ç–æ–º–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    router.forEach(page => {
      const key = getPageKey(page);
      if (existingCustomData[key]) {
        if (existingCustomData[key].pin) {
          page.pin = existingCustomData[key].pin;
        }
        if (existingCustomData[key].customMeta) {
          page.meta = page.meta || {};
          page.meta.custom = existingCustomData[key].customMeta;
        }
      }
    });
    
    fs.writeFileSync(routerPath, JSON.stringify(router, null, 2), 'utf8');
    console.log(`üîÑ Updated dev/__router.json (${router.length} pages)`);
    
    return router;
    
  } catch (e) {
    console.error('‚ùå Could not write router:', e.message);
    return router;
  }
}

export function generateRouterStats(router) {
  const stats = {
    total: router.length,
    categories: {},
    dynamic: router.filter(p => p.meta?.dynamic).length,
    static: router.filter(p => !p.meta?.dynamic).length
  };
  
  router.forEach(page => {
    const category = page.category || 'unknown';
    stats.categories[category] = (stats.categories[category] || 0) + 1;
  });
  
  return stats;
}

// =============================================================================
// ENHANCED ROUTER (—Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏)
// =============================================================================

export function generateEnhancedRouter(projectRoot = process.cwd()) {
  const router = generateRouterConfig(projectRoot);
  const stats = generateRouterStats(router);
  
  return {
    generated: new Date().toISOString(),
    version: getPackageVersion(projectRoot),
    stats,
    pages: router,
    categories: Object.keys(CATEGORY_CONFIG).map(key => ({
      key,
      ...CATEGORY_CONFIG[key],
      count: stats.categories[key] || 0
    }))
  };
}

// =============================================================================
// UTILITY FUNCTIONS
// =============================================================================

function capitalize(str) {
  return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
}

function getPageKey(page) {
  return path.basename(page.file, '.html');
}

function getPackageVersion(projectRoot) {
  try {
    const packagePath = path.resolve(projectRoot, 'package.json');
    const pkg = JSON.parse(fs.readFileSync(packagePath, 'utf8'));
    return pkg.version || '1.0.0';
  } catch {
    return '1.0.0';
  }
}

// =============================================================================
// CLI USAGE (–¥–ª—è —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞)
// =============================================================================
const isMainModule = process.argv[1] && process.argv[1].endsWith('router-generator.js');

if (isMainModule) {
  const command = process.argv[2];
  const projectRoot = process.argv[3] || process.cwd();
  
  console.log(`üöÄ Executing command: ${command || 'none'}`);
  
  switch (command) {
    case 'generate':
      console.log('üîÑ Generating router...');
      try {
        const result = updateDevRouter(projectRoot);
        console.log(`‚úÖ Success! Generated ${result.length} pages`);
      } catch (error) {
        console.error('‚ùå Error:', error.message);
      }
      break;
      
    case 'enhanced':
      console.log('üìä Generating enhanced router...');
      try {
        const enhanced = generateEnhancedRouter(projectRoot);
        const outputPath = path.resolve(projectRoot, 'dev/__router-enhanced.json');
        fs.writeFileSync(outputPath, JSON.stringify(enhanced, null, 2));
        console.log('‚úÖ Enhanced router saved to:', outputPath);
      } catch (error) {
        console.error('‚ùå Error:', error.message);
      }
      break;
      
    case 'test':
      console.log('üß™ Testing router generation...');
      try {
        const pagesDir = path.resolve(projectRoot, 'dev/pages');
        console.log('üìÅ Pages directory:', pagesDir);
        console.log('üìÅ Exists:', fs.existsSync(pagesDir));
        
        if (fs.existsSync(pagesDir)) {
          const files = fs.readdirSync(pagesDir).filter(f => f.endsWith('.html'));
          console.log('üìÑ Found pages:', files);
        }
        
        const router = generateRouterConfig(projectRoot);
        console.log('üìã Generated router:', router.length, 'pages');
        router.forEach(page => console.log(`  - ${page.name} (${page.file})`));
      } catch (error) {
        console.error('‚ùå Error:', error.message);
      }
      break;
      
    default:
      console.log(`
üìñ Usage: node build/router-generator.js <command> [project-root]

Commands:
  generate  - Generate basic router
  enhanced  - Generate enhanced router with stats  
  test      - Test router generation (debug)

Examples:
  node build/router-generator.js generate
  node build/router-generator.js test
      `);
  }
}
