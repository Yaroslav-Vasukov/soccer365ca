Документация оптимизированной Vite сборки
Обзор
Данная сборка представляет собой оптимизированную систему для разработки веб-сайтов с использованием Vite, Twig, SCSS и автоматической обработки ресурсов. Система спроектирована для максимальной производительности разработки и качества финального продукта.
Архитектура проекта
Структура папок
project/
├── build/                  # Вспомогательные скрипты сборки
│   └── router-generator.js # Автогенерация роутинга
├── dev/                    # Исходные файлы разработки
│   ├── assets/
│   │   ├── images/         # Изображения (автоконвертация в WebP)
│   │   ├── scripts/        # JavaScript модули
│   │   └── styles/         # SCSS файлы
│   ├── components/         # Twig компоненты
│   ├── data/              # JSON файлы с данными
│   ├── layouts/           # Базовые макеты
│   ├── pages/             # HTML страницы
│   └── __router.json      # Автогенерируемый роутинг
├── src/                   # Готовые файлы для деплоя
├── vite.config.js         # Конфигурация сборки
├── deploy.js              # FTP деплой
└── package.json
Ключевые возможности
1. Умная очистка build папки
Что делает: Безопасно очищает папку src/ перед сборкой, сохраняя важные серверные файлы.
Защищенные файлы:

.htaccess, web.config (конфигурации сервера)
*.php, *.py (серверные скрипты)
robots.txt, sitemap.xml (SEO файлы)
favicon.ico, .well-known (служебные файлы)

Удаляемые файлы: HTML, CSS, JS, изображения и другие build-артефакты.
2. Автогенерация роутинга
Файл: build/router-generator.js
Возможности:

Автоматическое сканирование папки dev/pages/
Генерация __router.json в dev и build режимах
Сохранение кастомных pin значений
Автодетекция новых/удаленных страниц в dev режиме

Формат router:
json[
  {
    "file": "home.html",
    "name": "Home",
    "pin": "",
    "url": "",
    "isHome": true
  },
  {
    "file": "pages/news.html",
    "name": "News",
    "pin": "",
    "url": "news",
    "isHome": false
  }
]
Команды:
bash# Ручная генерация
node build/router-generator.js generate

# Тестирование
node build/router-generator.js test
3. SCSS оптимизация
Возможности:

Кэширование компиляции для ускорения разработки
Source maps в dev режиме
Автоматический импорт utils/index в компоненты
Hot Module Replacement без перезагрузки страницы
Конвертация px в rem
Поддержка алиасов (@, @components)

Производительность:

Первая компиляция: ~200ms
Повторные компиляции: ~80-100ms
Cache hit: пропуск компиляции

4. Обработка изображений
WebP конвертация:

Автоматическая конвертация JPG/PNG в WebP
Lossless для PNG с альфа-каналом
Quality 82 для остальных изображений
Только измененные файлы конвертируются

В dev режиме:

Конвертация по мере изменения файлов
Автоматическая замена URL на WebP версии

В build режиме:

Массовая конвертация
Удаление оригинальных файлов
Перезапись ссылок в HTML/CSS

5. Twig интеграция
Возможности:

Унифицированный плагин для dev и build
Детальная обработка ошибок с красивыми страницами
Поддержка namespace для компонентов
Функция load_json() для загрузки данных
Автоматическая перезагрузка при изменениях

Пример использования load_json:
twig{% set posts = load_json('@/data/posts.json') %}
{% set teams = load_json('@/data/teams.json') %}
6. JSON валидация
Возможности:

Автоматическая проверка всех JSON файлов
Валидация в реальном времени при изменениях
Детальные сообщения об ошибках с номерами строк
Подсчет валидных/невалидных файлов

7. Performance оптимизации
Build оптимизации:

Tree shaking для удаления неиспользуемого кода
Разделение на чанки (vendor, components, utils)
Хэширование имен файлов для кэширования
Минификация через esbuild
Автогенерация входных точек

Dev оптимизации:

Быстрый file watching
Оптимизированные source maps
Предварительная сборка зависимостей

8. Deploy система
Файлы генерируемые при сборке:

__router.json - роутинг для фронтенда
build-info.json - информация о сборке
Оптимизированные HTML/CSS/JS файлы
WebP изображения

FTP деплой:
Используется существующий deploy.js с поддержкой инкрементальных обновлений.
Команды
Основные команды
bash# Разработка
npm run dev                 # Запуск dev сервера

# Сборка
npm run build              # Оптимизированная сборка
npm run build:clean        # Полная очистка и сборка

# Деплой
node deploy.js             # FTP загрузка на сервер
Дополнительные команды
bash# Router управление
node build/router-generator.js generate    # Генерация router
node build/router-generator.js test       # Тест генерации

# Деплой с проверкой
DRY_RUN=1 node deploy.js                  # Тест деплоя без загрузки
Environment переменные
Обязательные для деплоя
bashFTP_HOST=your-server.com
FTP_USER=username
FTP_PASSWORD=password
LOCAL_DIR=src
FTP_REMOTE_PATH=/public_html
Опциональные
bashNODE_ENV=development        # production для оптимизированной сборки
REM_ROOT=16                # Размер root em для px2rem конвертации
USE_PURGED=0               # Включение PurgeCSS
Workflow разработки
1. Ежедневная разработка
bash# Запуск dev окружения
npm run dev

# Файлы отслеживаются автоматически:
# - SCSS: быстрая перекомпиляция с кэшем
# - Twig: перезагрузка страницы
# - JSON: валидация в реальном времени
# - Images: конвертация в WebP
# - Pages: автообновление router
2. Добавление новой страницы
bash# 1. Создайте HTML файл
touch dev/pages/gallery.html

# 2. Автоматически:
# - Добавится в __router.json
# - Включится в build input
# - Настроится роутинг
3. Создание компонента
bash# Структура компонента
dev/components/card-post/
├── card-post.twig     # Шаблон
├── card-post.scss     # Стили  
└── card-post.js       # Логика

# Подключение
# 1. Импорт SCSS в main.scss
# 2. Подключение JS в main.js через when()
# 3. Использование в Twig templates
4. Сборка и деплой
bash# Проверочная сборка
npm run build

# Деплой
node deploy.js

# Проверка результата в build-info.json
Отладка
SCSS ошибки

Source maps доступны в браузере
Детальные сообщения в консоли
Время компиляции отображается

Twig ошибки

Красивые страницы ошибок в dev режиме
Указание файла, строки и колонки
Автоматическая перезагрузка при исправлении

JSON ошибки

Валидация при сохранении
Номера строк ошибок
Подсчет валидных файлов

Build ошибки

Детальные логи в консоли
Информация о размерах файлов
Предупреждения о пустых чанках

Производительность
Время сборки

Dev запуск: ~660ms
SCSS компиляция: 80-220ms
Build сборка: ~990ms для 17 страниц
Deploy: зависит от количества измененных файлов

Размеры файлов

CSS: ~45KB → ~9KB (gzip)
JS: Основной код ~1KB
HTML: Хорошее сжатие gzip (15-85%)
Images: WebP оптимизация

Кэширование

SCSS: интеллектуальный кэш по timestamp
Images: конвертация только измененных
Build: хэши в именах файлов
Browser: оптимальные заголовки кэширования

Техническая конфигурация
Поддерживаемые форматы

HTML: Twig шаблоны с namespace поддержкой
CSS: SCSS с автоимпортом utils
JS: ES2020 модули с tree shaking
Images: JPG, PNG, BMP → WebP конвертация
Data: JSON с автовалидацией

Алиасы путей
javascript@           → dev/
@components → dev/components/
@assets     → dev/assets/
Browser поддержка

ES2020+ (современные браузеры)
Automatic polyfills при необходимости
Source maps в development

Безопасность
Защита файлов

Автоматическая защита серверных конфигураций
Исключение служебных файлов из очистки
Валидация пользовательских данных

Деплой безопасность

Инкрементальные обновления
Проверка целостности файлов
Backup важных файлов перед заменой

Поддержка и расширение
Добавление новых плагинов
Плагины добавляются в vite.config.js в секцию plugins[].
Кастомизация SCSS

Переменные в dev/assets/styles/utils/
Компоненты в отдельных папках
Автоматический импорт utils

Расширение router

Модификация build/router-generator.js
Добавление новых типов страниц
Кастомные URL правила

Новые форматы данных

Добавление валидаторов в jsonValidationPlugin
Расширение load_json функции
Поддержка других форматов (YAML, XML)